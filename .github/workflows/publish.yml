name: Publish articles to Qiita

on:
  # main/master ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã‚’ãƒˆãƒªã‚¬ãƒ¼ã¨ã™ã‚‹
  push:
    branches:
      - main
      - master
  # æ‰‹å‹•å®Ÿè¡Œã‚’å¯èƒ½ã«ã™ã‚‹ï¼ˆActionsã‚¿ãƒ–ã‹ã‚‰å®Ÿè¡Œå¯èƒ½ï¼‰
  workflow_dispatch:

permissions:
  # ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆè¨˜äº‹ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ã¸ã®æ›¸ãè¾¼ã¿æ¨©é™ãŒå¿…è¦
  contents: write

concurrency:
  # è¤‡æ•°å®Ÿè¡ŒãŒåŒæ™‚ã«èµ°ã‚‰ãªã„ã‚ˆã†ã«åˆ¶å¾¡
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  publish_articles:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout Repository
        # ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # å·®åˆ†æ¤œå‡ºã®ãŸã‚ã«å±¥æ­´å…¨ä½“ã‚’å–å¾—

      - name: Setup Node.js 22
        # Node.jsç’°å¢ƒï¼ˆè­¦å‘Šã®å‡ºã¦ã„ãŸ20ã§ã¯ãªã22ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼‰
        uses: actions/setup-node@v3
        with:
          node-version: '22'

      - name: Get changed markdown files
        # å¤‰æ›´ã•ã‚ŒãŸMarkdownãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆarticles/é…ä¸‹ã®.mdãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ã‚’æ¤œå‡ºã—ã€ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
        id: files
        run: |
          # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«å‡ºåŠ›
          git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep "^articles/.*\.md$" > $GITHUB_WORKSPACE/changed_files.txt || true
          
          # åˆå›ã‚³ãƒŸãƒƒãƒˆã‚„å±¥æ­´ãŒãªã„å ´åˆã«ã€HEAD~1ã¨ã®å·®åˆ†ã‚‚ç¢ºèª
          if [ -z "${{ github.event.before }}" ] || [ "$(wc -l < $GITHUB_WORKSPACE/changed_files.txt)" -eq 0 ]; then
              echo "No files found in normal diff, checking last commit..."
              git diff --name-only HEAD~1 HEAD | grep "^articles/.*\.md$" > $GITHUB_WORKSPACE/changed_files.txt || true
          fi
          
          echo "ğŸ“‹ Changed markdown files:"
          cat $GITHUB_WORKSPACE/changed_files.txt
          
          # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ã‚’OUTPUTã«è¨­å®š
          if [ "$(wc -l < $GITHUB_WORKSPACE/changed_files.txt)" -gt 0 ]; then
              echo "found_files=true" >> $GITHUB_OUTPUT
          else
              echo "found_files=false" >> $GITHUB_OUTPUT
          fi
        shell: bash

      # ----------------------------------------------------
      # å®‰å®šç‰ˆã® zenn-sync-action ã«åˆ‡ã‚Šæ›¿ãˆ
      # ----------------------------------------------------
      - name: Sync Zenn articles to Qiita (using suin/zenn-sync-action)
        # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã€ã‹ã¤ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã®å ´åˆã«ã®ã¿å®Ÿè¡Œ
        if: steps.files.outputs.found_files == 'true'
        # Gitæ“ä½œã®ã‚¨ãƒ©ãƒ¼ãŒè§£æ¶ˆã™ã‚‹ã€å®‰å®šã—ãŸã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨
        uses: suin/zenn-sync-action@v1
        with:
          # GitHub Secretsã«è¨­å®šã—ãŸQiitaãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨
          qiita-token: ${{ secrets.QIITA_TOKEN }}