name: Publish articles

on:
  # main/master ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã‚’ãƒˆãƒªã‚¬ãƒ¼ã¨ã™ã‚‹
  push:
    branches:
      - main
      - master
  # æ‰‹å‹•å®Ÿè¡Œã‚’å¯èƒ½ã«ã™ã‚‹ï¼ˆActionsã‚¿ãƒ–ã‹ã‚‰å®Ÿè¡Œå¯èƒ½ï¼‰
  workflow_dispatch:

permissions:
  # ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆè¨˜äº‹ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ã¸ã®æ›¸ãè¾¼ã¿æ¨©é™ãŒå¿…è¦
  contents: write

concurrency:
  # è¤‡æ•°å®Ÿè¡ŒãŒåŒæ™‚ã«èµ°ã‚‰ãªã„ã‚ˆã†ã«åˆ¶å¾¡
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  publish_articles:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        # ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # å·®åˆ†æ¤œå‡ºã®ãŸã‚ã«å±¥æ­´å…¨ä½“ã‚’å–å¾—

      - name: Setup Node.js
        # Node.jsç’°å¢ƒï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³22ï¼‰ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v3
        with:
          node-version: '22'

      - name: Get changed markdown files
        # å¤‰æ›´ã•ã‚ŒãŸMarkdownãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œå‡ºã—ã€å¾Œç¶šã®ã‚¹ãƒ†ãƒƒãƒ—ã§ä½¿ã†ãŸã‚ã®ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
        id: files
        run: |
          touch $GITHUB_WORKSPACE/changed_files.txt
          
          git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep "^articles/.*\.md$" > $GITHUB_WORKSPACE/changed_files.txt || true
          
          if [ -z "${{ github.event.before }}" ] || [ "$(wc -l < $GITHUB_WORKSPACE/changed_files.txt)" -eq 0 ]; then
              echo "No files found in normal diff, checking last commit..."
              git diff --name-only HEAD~1 HEAD | grep "^articles/.*\.md$" > $GITHUB_WORKSPACE/changed_files.txt || true
          fi
          
          if [ "$(wc -l < $GITHUB_WORKSPACE/changed_files.txt)" -eq 0 ] && [[ "${{ github.event.pull_request.title }}" == *"#"* ]]; then
              PR_NUM=$(echo "${{ github.event.pull_request.title }}" | grep -o '#[0-9]*' | tr -d '#')
              if [ -n "$PR_NUM" ] && [ -f "articles/openhands_introduction.md" ]; then
                  echo "articles/openhands_introduction.md" > $GITHUB_WORKSPACE/changed_files.txt
              fi
          fi
          
          echo "ğŸ“‹ Changed markdown files:"
          cat $GITHUB_WORKSPACE/changed_files.txt
          
          if [ "$(wc -l < $GITHUB_WORKSPACE/changed_files.txt)" -gt 0 ]; then
              echo "found_files=true" >> $GITHUB_OUTPUT
          else
              echo "found_files=false" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: Install qiita-cli
        # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆã«ã®ã¿Qiita CLIã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        if: steps.files.outputs.found_files == 'true'
        run: |
          npm install @qiita/qiita-cli --save-dev
        shell: bash

      - name: Run zenn-qiita-sync
        # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆã«ã®ã¿åŒæœŸã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ
        if: steps.files.outputs.found_files == 'true'
        uses: C-Naoki/zenn-qiita-sync@main
        with:
          # GitHub Secretsã«è¨­å®šã—ãŸQiitaãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨
          qiita-token: ${{ secrets.QIITA_TOKEN }}